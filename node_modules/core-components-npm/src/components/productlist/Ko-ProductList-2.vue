<template>
  <div class="wrapper-productlist" :style="Settings">
    <div class="container">
      <!-- buscador -->
      <div class="top-right">
        <div class="content-title">
          <div>
            <p class="title">Catálogo</p>
          </div>
          <div class="top-input-search">
            <input v-model="search" type="email" placeholder="Buscar" />
            <i class="icon-search"></i>
          </div>
        </div>
        <div class="content-title-mobil">
          <div class="menu-mobil" @click="drawerleft = true">
            <p class="filtrar">Filtrar</p>
            <Flechadown class="header-icon-menu nav-bar-left" />
          </div>
          <div class="top-input-search">
            <input v-model="search" type="email" placeholder="Buscar" />
            <i class="icon-search"></i>
          </div>
        </div>
        <!-- menu lateral responsive -->
        <el-drawer
          :visible.sync="drawerleft"
          :direction="directionleft"
          class="drawer-left"
          :style="Settings"
        >
          <div class="sidebar-container">
            <div class="header-content-logo-navbar">
              <span @click="drawerleft = false">
                <window-close-icon class="header-icon-close" />
              </span>
              <!-- catálogo  -->
              <div class="content-item-catalogo2">
                <ul class="a-container">
                  <li @click="clear">
                    <p class="item-categoria">Todos</p>
                  </li>
                  <!-- item -->
                  <li
                    @mouseover="mouseOver(index)"
                    @mouseleave="mouseLeave"
                    v-for="(categoria, index) in categorias"
                    :key="categoria.id"
                  >
                    <label>
                      <p
                        class="item-categoria"
                        :class="
                          index == indexSelect ? 'item-categoria-active' : ''
                        "
                        @click="
                          sendCategory(
                            categoria,
                            categoria.id,
                            index,
                            (ref = false)
                          )
                        "
                      >
                        {{ categoria.nombre_categoria_producto }}
                      </p>
                      <div
                        :style="indexCategory == index ? '' : 'display: none'"
                        class="content-item-subcategorie"
                      >
                        <li
                          v-for="subcategory in selectedSubcategories"
                          @click="Sendsubcategory(subcategory.id)"
                          :class="
                            subcategory.id == indexSelect2
                              ? 'item-subcategorie-active'
                              : ''
                          "
                          :key="subcategory.id"
                        >
                          <p class="item-subcategorie">
                            {{ subcategory.nombre_subcategoria }}
                          </p>
                        </li>
                      </div>
                      <div
                        :class="{ popover: sub == index }"
                        v-if="sub == index"
                      ></div>
                    </label>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </el-drawer>
      </div>
      <!-- Content producto -->
      <div class="content-item">
        <!-- catálogo  -->
        <div class="content-item-catalogo">
          <ul class="a-container">
            <li @click="clear">
              <p class="item-categoria">Todos</p>
            </li>
            <!-- item -->
            <li
              @mouseover="mouseOver(index)"
              @mouseleave="mouseLeave"
              v-for="(categoria, index) in categorias"
              :key="categoria.id"
            >
              <label>
                <p
                  class="item-categoria"
                  :class="index == indexSelect ? 'item-categoria-active' : ''"
                  @click="
                    sendCategory(categoria, categoria.id, index, (ref = false))
                  "
                >
                  {{ categoria.nombre_categoria_producto }}
                </p>
                <div
                  :style="indexCategory == index ? '' : 'display: none'"
                  class="content-item-subcategorie"
                >
                  <li
                    v-for="subcategory in selectedSubcategories"
                    @click="Sendsubcategory(subcategory.id)"
                    :class="
                      subcategory.id == indexSelect2
                        ? 'item-subcategorie-active'
                        : ''
                    "
                    :key="subcategory.id"
                  >
                    <p class="item-subcategorie">
                      {{ subcategory.nombre_subcategoria }}
                    </p>
                  </li>
                </div>
                <div
                  :class="{ popover: sub == index }"
                  v-if="sub == index"
                ></div>
              </label>
            </li>
          </ul>
        </div>
        <!-- productos -->
        <div class="content-item-productos">
          <div class="grid-products">
            <div
              v-for="product in filterProduct"
              :key="product.id"
              class="content-products"
            >
              <KoProductCard2
                :product="product"
                :Settings="Settings"
              ></KoProductCard2>
            </div>
          </div>
          <!-- paginación -->
          <div class="pagination-medium">
            <div class="product_pagination" v-if="products.length > 40">
              <el-pagination
                layout="prev, pager, next"
                :total="products.length"
                :page-size="40"
                :current-page.sync="currentPage"
                class="pagination"
              ></el-pagination>
            </div>
          </div>
        </div>
        <!-- paginación -->
      </div>
    </div>
  </div>
</template>

<script>
import KoProductCard2 from "../_productcard/Ko-ProductCard-2";
export default {
  components: {
    KoProductCard2
  },
  props: {
    dataStore: Object,
    fullProducts: {},
    Settings: Object
  },
  name: "Ko-ProductList-2",
  mounted() {
    this.$store.commit("products/SET_FILTER", this.$route.query);
    if (this.$store.getters["products/filterProducts"]) {
      this.products = this.$store.getters["products/filterProducts"];
      let maxTMP = 0;
      this.products.forEach(product => {
        if (maxTMP <= product.precio) {
          this.price[1] = product.precio;
          this.range.max = parseInt(product.precio);
          maxTMP = product.precio;
        }
      });
    }
  },
  data() {
    return {
      drawerleft: false,
      directionleft: "ltr",
      add: true,
      search: "",
      productsCategory: [],
      price: [0, 1000000],
      range: {
        max: 0
      },
      currentPage: 1,
      sub: -1,
      show: false,
      value: "",
      valuesub: "",
      selectSubcategory: "",
      nameCategory: "",
      selectedSubcategories: [],
      toggleCategories: true,
      indexCategory: 0,
      indexSelect: "",
      indexSelect2: ""
    };
  },
  watch: {
    fullProducts(value) {
      this.products = value;
      let maxTMP = 0;
      value.forEach(product => {
        if (maxTMP <= product.precio) {
          this.price[1] = product.precio;
          this.range.max = parseInt(product.precio);
          maxTMP = product.precio;
        }
      });
    },
    search(value) {
      this.Searchproduct(value);
    },
    currentPage() {
      let timerTimeout = null;
      timerTimeout = setTimeout(() => {
        timerTimeout = null;
        window.scrollTo(0, 0);
      }, 250);
    }
  },
  computed: {
    selectedCard() {
      return this.dataStore.selectedCard;
    },
    products: {
      get() {
        return this.dataStore.productos;
      },
      set(value) {
        this.dataStore.productos = value;
      }
    },
    categorias() {
      return this.dataStore.categorias;
    },
    subcategories() {
      return this.dataStore.subcategorias;
    },
    getProductsCategorie() {
      const initial = this.currentPage * 40 - 40;
      const final = initial + 40;
      return this.fullProducts
        .filter(product => product.categoria == this.select)
        .slice(initial, final);
    },
    filterProduct() {
      const initial = this.currentPage * 40 - 40;
      const final = initial + 40;
      return this.products.slice(initial, final);
    },
    selectedCategory() {
      return this.$store.state.products.payload;
    },
    selectedType() {
      return this.$store.state.products.type;
    }
  },
  methods: {
    back() {
      this.clear();
      this.toggleCategories = true;
      this.nameCategory = "";
    },
    Allcategories() {
      this.$store.commit("products/FILTER_BY", {
        type: "all",
        data: ""
      });
      this.currentPage = 1;
    },
    Searchproduct(search) {
      if (search.length) {
        this.$store.commit("products/FILTER_BY", {
          type: "search",
          data: search
        });
      } else {
        this.$store.commit("products/FILTER_BY", {
          type: "all",
          data: ""
        });
      }
      this.currentPage = 1;
    },
    addClass() {
      this.add = !this.add;
    },
    mouseOver(index) {
      this.sub = index;
      this.show = true;
    },
    mouseLeave() {
      this.sub = -1;
      this.show = false;
    },
    Sendsubcategory(value) {
      this.indexSelect2 = value;
      this.addClass();
      this.selectSubcategory = value;
      this.$store.commit("products/FILTER_BY", {
        type: "subcategory",
        data: value
      });
    },
    sendCategory(value, categoria, index, ref) {
      this.indexSelect = index;
      this.currentPage = 1;
      this.nameCategory = value.nombre_categoria_producto;
      this.indexCategory = index;
      this.selectedSubcategories = [];
      this.subcategories.find(subcategoria => {
        if (subcategoria.categoria === categoria) {
          this.toggleCategories = false;
          this.selectedSubcategories.push(subcategoria);
        }
      });
      if (this.selectedSubcategories.length === 0) {
        this.addClass();
      }
      if (ref) {
        this.addClass();
      }
      this.$store.commit("products/FILTER_BY", {
        type: "category",
        data: value.nombre_categoria_producto
      });
    },
    clear() {
      this.$store.commit("products/FILTER_BY", {
        type: "all",
        data: ""
      });
      this.$emit("clear");
      this.addClass();
      this.nameCategory = "";
    }
  }
};
</script>
<style scoped>
.wrapper-productlist {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  background: var(--background_color_1);
  box-sizing: border-box;
}
.container {
  display: flex;
  justify-content: center;
  width: 100%;
  max-width: 1300px;
  padding: 30px 20px 0;
  flex-direction: column;
}
.content-title {
  width: 100%;
  flex-direction: row;
  display: flex;
  justify-content: space-between;
}
.content-title-mobil {
  display: none;
}
.title {
  font-size: 38px;
  font-weight: bold;
  font-stretch: normal;
  font-style: normal;
  line-height: 1.24;
  letter-spacing: -0.4px;
  color: var(--color_text);
}

.content-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-direction: row;
  margin-bottom: 40px;
}
.content-item > div:nth-child(1) {
  flex: 1;
}
.content-item > div:nth-child(2) {
  flex: 2;
}
/* ///////categorias//////////// */
.content-item-catalogo {
  display: flex;
  align-self: baseline;
  margin-right: 5px;
  max-width: 205px;
  width: 100%;
}
.a-container {
  margin-right: 30px;
  width: 205px;
  display: block;
  position: relative;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  border-radius: 10px;
  color: var(--color_subtext);
  background-color: var(--background_color_2);
  -webkit-transition: all 0.2s ease;
  -moz-transition: all 0.2s ease;
  -ms-transition: all 0.2s ease;
  -o-transition: all 0.2s ease;
  transition: all 0.2s ease;
  align-items: center;
  justify-content: center;
}
.item-categoria {
  cursor: pointer;
  padding-left: 5px;
}
.item-categoria-active {
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
  background: var(--color_background_hover);
  color: var(--color_hover_text);
}
.item-categoria:hover {
  background: var(--color_background_hover);
  color: var(--color_hover_text);
  border-radius: 10px;
}
/*////// subcategoria //////*/
.content-item-subcategorie {
  background: var(--color_background_hover);
  padding-right: 10px;
  padding-left: 20px;
  border-bottom-right-radius: 10px;
  border-bottom-left-radius: 10px;
}
.item-subcategorie {
  font-size: 13px;
  cursor: pointer;
  user-select: none;
}
.item-subcategorie-active {
  color: var(--color_hover_text);
}
.item-subcategorie:hover {
  background: var(--color_background_hover);
  color: var(--color_hover_text);
}

/* ///////productos/////////// */
.content-products {
  border-radius: 10px;
  margin-top: 10px;
}
.content-products:hover,
.content-products:focus {
  box-shadow: 0px 0px 2px 1px var(--color_border);
  border-radius: 10px;
}
.content-item-productos {
  display: flex;
  max-width: auto;
  width: 100%;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}
.grid-products {
  width: auto;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(1, minmax(200px, 1fr));
  /* grid-gap: 10px; */
  box-sizing: border-box;
}

/* //////buscador ///////// */
.top-right {
  width: 100%;
  padding-top: 10px;
  padding-bottom: 15px;
}
.header-icon-menu {
  cursor: pointer;
  font-size: 32px;
  color: var(--color_icon);
}
.header-icon-close {
  font-size: 30px;
  color: var(--color_icon);
  margin-left: 22px;
}
.header-icon-menu:hover,
.header-icon-close:hover {
  color: var(--color_hover_text);
}

.top-input-search {
  position: relative;
  display: grid;
  align-content: start;
  justify-content: flex-end;
}
.top-input-search input {
  width: 100%;
  padding: 10px 35px 10px 15px;
  box-sizing: border-box;
  font-size: 14px;
  color: var(--color_subtext);
  border: solid 2px #afafaf;
  border-radius: var(--radius_btn);
  background-color: transparent;
}
.top-input-search input::placeholder {
  color: var(--color_subtext);
  opacity: 0.7;
}
.top-input-search input:focus,
.top-input-search input:active {
  border: solid 2px #afafaf;
  border-radius: var(--radius_btn);
  outline: 0;
}
.top-input-search i.icon-search {
  position: absolute;
  top: 9px;
  right: 15px;
  z-index: 2;
  color: var(--color_subtext);
  font-weight: bold;
}
.top-input-search .response {
  justify-self: start;
  padding: 0 10px;
  height: 32px;
  line-height: 30px;
  font-size: 12px;
  color: var(--color_subtext);
  border: solid 2px #d8d8d8;
  border-radius: var(--radius_btn);
  background-color: transparent;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
  white-space: nowrap;
  height: 28px;
  line-height: 26px;
}

/* //////paginacion//////// */
.pagination-medium {
  margin-top: 10px;
  background: var(--background_color_1);
}
.pagination {
  font-size: 18px;
  color: var(--color_text);
}
.el-pager li.active,
.el-pager li.hover,
.el-pager li.focus {
  color: var(--color_text);
}
.popover {
  width: 300px;
  background-color: var(--background_color_1);
  position: absolute;
  right: -240px;
  top: 0;
  z-index: 99;
  box-sizing: border-box;
}
.menu-mobil {
  display: none;
}
.drawer-left {
  display: none;
}

@media (max-width: 1000px) {
  /* ///////productos/////////// */
  .container {
    padding: 0px;
  }
  .content-title {
    display: none;
  }
  .el-drawer__body {
    background: var(--background_color_1);
  }
  .content-title-mobil {
    width: 100%;
    flex-direction: row;
    display: flex;
    justify-content: space-between;
  }
  .filtrar {
    font-size: 16px;
    font-weight: bold;
    line-height: 1.4;
    color: var(--color_text);
    align-self: flex-end;
    cursor: pointer;
    margin-right: 2px;
  }
  .content-item-catalogo {
    display: none;
  }
  .top-right {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    background: var(--background_color_2);
  }
  .menu-mobil {
    display: flex;
    align-self: center;
    align-self: flex-start;
    margin-left: 30px;
    /* position: absolute; */
  }
  .drawer-left {
    display: initial;
  }
  .content-item-catalogo2 {
    display: flex;
    align-self: baseline;
    margin-left: 20px;
    max-width: 205px;
    width: 100%;
  }
  .a-container {
    font-family: Poppins;
  }
}
</style>
